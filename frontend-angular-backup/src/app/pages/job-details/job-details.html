<div class="details-container">
  <div class="back-btn-area">
    <a routerLink="/dashboard" mat-button>
      <mat-icon>arrow_back</mat-icon>
      Voltar para vagas
    </a>
  </div>

  @if (isLoading) {
  <mat-spinner></mat-spinner>
  }

  @if (!isLoading && job) {
  <mat-card class="job-details-card">
    <mat-card-header>
      <mat-card-title class="job-title-container">
        <span>{{ job.title }}</span>

        @if (isAuthor) {
        <div>
          <button mat-icon-button (click)="openEditJobDialog()">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="onDeleteJob()">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        }
      </mat-card-title>
      <mat-card-subtitle>Publicado por <a [routerLink]="['/profile', job.author.user.id]">{{ job.author.companyName ||
          (job.author.user.firstName + ' ' + job.author.user.lastName) }}</a>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <h3>Descrição</h3>
      <p class="description">{{ job.description }}</p>

      @if (job.budget) {
      <h3>Orçamento</h3>
      <p class="budget">{{ job.budget | currency:'BRL' }}</p>
      }

      @if (job.requiredSkills && job.requiredSkills.length > 0) {
      <h3>Habilidades Necessárias</h3>
      <mat-chip-listbox aria-label="Habilidades da vaga">
        @for (skill of job.requiredSkills; track skill.id) { <mat-chip disabled>{{ skill.name }}</mat-chip> }
      </mat-chip-listbox>
      }
    </mat-card-content>

    <mat-card-actions>
      @if (userRole === 'FREELANCER' && !job.hasApplied) {
      <button mat-raised-button color="primary" (click)="onApply()">
        <mat-icon>send</mat-icon>
        Candidatar-se Agora
      </button>
      }

      @if (userRole === 'FREELANCER' && job.hasApplied) {
      <button mat-flat-button color="accent" disabled>
        <mat-icon>check_circle</mat-icon>
        Candidatura Enviada
      </button>
      @if (myApplication?.status === 'PENDING') {
      <button mat-stroked-button class="btn btn-outline btn-danger" (click)="onCancelMyApplication()">
        <mat-icon>cancel</mat-icon>
        Cancelar Candidatura
      </button>
      }
      }

    </mat-card-actions>
  </mat-card>

  @if (isAuthor) {
  <mat-card class="applicants-card">
    <mat-card-header>
      <mat-card-title>Candidatos para esta Vaga</mat-card-title>
    </mat-card-header>
    <mat-card-content>

      <mat-form-field appearance="outline" class="filter-input">
        <mat-label>Filtrar por skill</mat-label>
        <input matInput [formControl]="applicantFilterControl" placeholder="Ex: Pet Sitter">
      </mat-form-field>

      @if (applicants$ | async; as applicants) {
      <p><strong>Total: {{ applicants.length }}</strong></p>
      @if (applicants.length > 0) {
      <mat-list role="list">
        @for (app of applicants; track app.applicant.id) {
        <mat-list-item role="listitem" class="applicant-item">

          <div class="applicant-item-content">

            <a [routerLink]="['/profile', app.applicant.id]" class="applicant-link">
              {{ app.applicant.firstName }} {{ app.applicant.lastName }}
            </a>

            <div class="applicant-actions">
              <button mat-icon-button (click)="onStartConversation(app.id)" matTooltip="Iniciar conversa">
                <mat-icon>chat</mat-icon>
              </button>
              @if (app.status === 'PENDING') {
              <button mat-icon-button color="primary" (click)="updateApplicationStatus(app.id, 'SHORTLISTED')"
                matTooltip="Selecionar candidato">
                <mat-icon>thumb_up</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="updateApplicationStatus(app.id, 'REJECTED')"
                matTooltip="Rejeitar candidato">
                <mat-icon>thumb_down</mat-icon>
              </button>
              } @else {
              <span class="status-chip" [ngClass]="app.status.toLowerCase()">{{ translateApplicationStatus(app.status)
                }}</span>

              @if (app.status === 'SHORTLISTED') {
              @if (!app.jobStatus || app.jobStatus === 'ACTIVE') {
              <button mat-button color="primary" (click)="onRequestClosure(app.id)">
                <mat-icon>flag</mat-icon>
                Solicitar Encerramento
              </button>
              }
              @if (app.jobStatus === 'COMPLETED' && !app.clientReview) {
              <button mat-raised-button class="evaluate-button" (click)="openClientReview(app)">
                <mat-icon>star</mat-icon>
                avaliar
              </button>
              }
              <span class="status-chip small" *ngIf="app.jobStatus">{{ translateJobStatus(app.jobStatus) }}</span>
              }
              }
            </div>

          </div>
        </mat-list-item>
        }
      </mat-list>
      } @else {
      <p>Nenhum candidato encontrado com este filtro.</p>
      }
      }
    </mat-card-content>
  </mat-card>
  }
  }

  @if (!isLoading && !job) {
  <div>
    <h2>Vaga não encontrada</h2>
    <p>A vaga que você está procurando não existe ou pode ter sido removida.</p>
  </div>
  }
</div>